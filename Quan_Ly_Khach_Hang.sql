create database Quan_Ly_Khach_Hang;
use Quan_Ly_Khach_Hang;


-- tạo bảng khu vực
create table KHU_VUC (
	ID_KV NCHAR(5) PRIMARY KEY ,
	TEN_KV NVARCHAR (50)
);

-- tạo bảng loại khách hàng
CREATE TABLE LOAI_KHACH_HANG(
	ID_LOAIKH NCHAR(5)  PRIMARY KEY,
	TEN_LOAIKH NVARCHAR(50)
);
-- tạo bảng khách hàng
CREATE TABLE KHACH_HANG(
	ID_KH NCHAR(7) PRIMARY KEY DEFAULT DBO.AUTO_IDKH(),
	TEN_KH NVARCHAR(100),
	GIOITINH BIT,
	NGAYSINH DATE,
	SDT NCHAR(10),
	EMAIL NCHAR(70),
	DIACHI NVARCHAR(100),
	ID_KV NCHAR(5) FOREIGN KEY REFERENCES KHU_VUC(ID_KV),
	ID_LOAIKH NCHAR(5) FOREIGN KEY REFERENCES LOAI_KHACH_HANG(ID_LOAIKH),
	DIEM INT
);

-- tạo bảng chức vụ 
CREATE TABLE CHUC_VU (
	ID_CHUCVU NCHAR(5)  PRIMARY KEY,
	TEN_CHUCVU NVARCHAR(50)
);

-- tạo bảng nhân viên
create table NHAN_VIEN(
	ID_NV NCHAR(5) PRIMARY KEY DEFAULT DBO.AUTO_IDNV(),
	TEN_NV NVARCHAR(100),
	GIOITINH BIT,
	NGAYSINH DATE,
	SDT NCHAR(10),
	EMAIL NCHAR(70),
	DIACHI NVARCHAR(100),
	ID_CHUCVU NCHAR(5) FOREIGN KEY REFERENCES CHUC_VU(ID_CHUCVU),
);

create table account(
	name_user nvarchar(20) PRIMARY KEY,
	pass nvarchar(40)
	
);


-- tạo bảng sản phẩm
CREATE TABLE DICH_VU(
	ID_DV  NCHAR(10)   PRIMARY KEY,
	TEN_DV NVARCHAR (100),
	GIA FLOAT
);



-- tạo bảng hóa đơn
CREATE TABLE HOA_DON(
	ID_HD NCHAR(9) PRIMARY KEY DEFAULT DBO.AUTO_IDHD(),
	NGAY_TAO DATE,
	NGAY_HET_HAN_BH DATE,
	ID_KH NCHAR(7) FOREIGN KEY REFERENCES KHACH_HANG(ID_KH),
	ID_NV NCHAR(5) FOREIGN KEY REFERENCES NHAN_VIEN(ID_NV)
);
-- tạo bảng chi tiết hóa đơn
CREATE TABLE CTHD(
	ID_HD NCHAR(9)FOREIGN KEY REFERENCES HOA_DON(ID_HD),
	ID_DV NCHAR(10) FOREIGN KEY REFERENCES DICH_VU(ID_DV),
	SO_LUONG INT
);

CREATE FUNCTION AUTO_IDKH()
RETURNS NCHAR(7)
AS
BEGIN
	DECLARE @ID  NCHAR(7)
	IF (SELECT COUNT(ID_KH) FROM KHACH_HANG) = 0
		SET @ID = '0'
	ELSE
		SELECT @ID = MAX(RIGHT(ID_KH, 5)) FROM KHACH_HANG
		SELECT @ID = CASE
			WHEN @ID >= 0 and @ID < 9 THEN 'KH0000' + CONVERT(NCHAR, CONVERT(INT, @ID) + 1)
			WHEN @ID >= 9 THEN 'KH000' + CONVERT(NCHAR, CONVERT(INT, @ID) + 1)
			WHEN @ID >= 99 THEN 'KH00' + CONVERT(NCHAR, CONVERT(INT, @ID) + 1)
			WHEN @ID >= 999 THEN 'KH0' + CONVERT(NCHAR, CONVERT(INT, @ID) + 1)
		END
	RETURN @ID
END
 
CREATE FUNCTION AUTO_IDNV()
RETURNS NCHAR(5)
AS
BEGIN
	DECLARE @ID  NCHAR(5)
	IF (SELECT COUNT(ID_NV) FROM NHAN_VIEN) = 0
		SET @ID = '0'
	ELSE
		SELECT @ID = MAX(RIGHT(ID_NV, 3)) FROM NHAN_VIEN
		SELECT @ID = CASE
			WHEN @ID >= 0 and @ID < 9 THEN 'NV00' + CONVERT(NCHAR, CONVERT(INT, @ID) + 1)
			WHEN @ID >= 9 THEN 'NV0' + CONVERT(NCHAR, CONVERT(INT, @ID) + 1)
		END
	RETURN @ID
END

CREATE FUNCTION AUTO_IDHD()
RETURNS NCHAR(9)
AS
BEGIN
	DECLARE @ID  NCHAR(9)
	IF (SELECT COUNT(ID_HD) FROM HOA_DON) = 0
		SET @ID = '0'
	ELSE
		SELECT @ID = MAX(RIGHT(ID_HD, 6)) FROM HOA_DON
		SELECT @ID = CASE
			WHEN @ID >= 0 and @ID < 9 THEN 'HDB00000' + CONVERT(NCHAR, CONVERT(INT, @ID) + 1)
			WHEN @ID >= 9 THEN 'HDB0000' + CONVERT(NCHAR, CONVERT(INT, @ID) + 1)
			WHEN @ID >= 99 THEN 'HDB000' + CONVERT(NCHAR, CONVERT(INT, @ID) + 1)
			WHEN @ID >= 999 THEN 'HDB00' + CONVERT(NCHAR, CONVERT(INT, @ID) + 1)
			WHEN @ID >= 9999 THEN 'HDB0' + CONVERT(NCHAR, CONVERT(INT, @ID) + 1)
		END
	RETURN @ID
END

-- insert table KHU_VUC
INSERT INTO KHU_VUC VALUES ('KV_01', N'Nội thành')
INSERT INTO KHU_VUC VALUES ('KV_02', N'Ngoại thành')
SELECT * FROM KHU_VUC;

-- insert table LOAI_KHACH_HANG
INSERT INTO LOAI_KHACH_HANG VALUES ('KH_TT',N'Khách thân thiết')
INSERT INTO LOAI_KHACH_HANG VALUES ('KH_TH',N'Khách thường')
SELECT* FROM LOAI_KHACH_HANG;


-- insert table KHACH_HANG

INSERT INTO KHACH_HANG(TEN_KH, GIOITINH, NGAYSINH, SDT, EMAIL, DIACHI, ID_KV,ID_LOAIKH, DIEM) VALUES 
	(N'Văn Hoài An',1, CONVERT(date, '12/9/1998'),'0908787878', 'anhnh@gmail.com',N'83/12T Mạc Thị Bưởi, Quận Bình Thạnh', 'KV_01','KH_TH', 20)
INSERT INTO KHACH_HANG(TEN_KH, GIOITINH, NGAYSINH, SDT, EMAIL, DIACHI, ID_KV,ID_LOAIKH, DIEM) VALUES 
	(N'Nguyễn Hoàng Tuấn',1, CONVERT(date, '8/25/1999'),'098989898', 'tuanm@gmail.com',N'Chung cư Ánh Sáng, Hà Nội', 'KV_02','KH_TH',25)
INSERT INTO KHACH_HANG(TEN_KH, GIOITINH, NGAYSINH, SDT, EMAIL, DIACHI, ID_KV,ID_LOAIKH, DIEM) VALUES 
	(N'Trần Ngọc Hoa',0, CONVERT(date, '10/17/1998'),'099090909', 'hoant@gmail.com',N'678/12/87 Lê Thánh Tôn, Q1', 'KV_01','KH_TH', 10)
INSERT INTO KHACH_HANG(TEN_KH, GIOITINH, NGAYSINH, SDT, EMAIL, DIACHI, ID_KV,ID_LOAIKH, DIEM) VALUES 
	(N'Trân Thị Trân',0, CONVERT(date, '12/19/2001'),'099232323', 'trantranthi@gmail.com',N'Bình Dương', 'KV_02','KH_TH', 10)
INSERT INTO KHACH_HANG(TEN_KH, GIOITINH, NGAYSINH, SDT, EMAIL, DIACHI, ID_KV,ID_LOAIKH, DIEM) VALUES 
	(N'Trần Thị Như Ý',0, CONVERT(date, '1/20/1997'),'0708657839', 'ynhu@gmail.com',N'23 bis Lê Văn Việt, Q.9', 'KV_01','KH_TH', 12)
INSERT INTO KHACH_HANG(TEN_KH, GIOITINH, NGAYSINH, SDT, EMAIL, DIACHI, ID_KV,ID_LOAIKH, DIEM) VALUES 
	(N'Nguyễn Hoàng',1, CONVERT(date, '01/01/2000'),'0908212121', 'hoang@gmail.com',N'23 bis Hồ Hảo Hớn, Thành Phố Thủ Đức', 'KV_01','KH_TT', 100)
INSERT INTO KHACH_HANG(TEN_KH, GIOITINH, NGAYSINH, SDT, EMAIL, DIACHI, ID_KV,ID_LOAIKH, DIEM) VALUES 
	(N'Nguyễn Tú',1, CONVERT(date, '11/6/1997'),'0908343434', 'tucaunguyen@gmail.com',N'128/29 Quang Trung, Q. GV', 'KV_01','KH_TH', 35)
INSERT INTO KHACH_HANG(TEN_KH, GIOITINH, NGAYSINH, SDT, EMAIL, DIACHI, ID_KV,ID_LOAIKH, DIEM) VALUES 
	(N'Phạm Thủy Tú',1, CONVERT(date, '2/7/2000'),'0108786668', 'thuytu@gmail.com',N'45/4 Chung cư Vin Mart, Quận Bình Thạnh', 'KV_01','KH_TT', 50)
INSERT INTO KHACH_HANG(TEN_KH, GIOITINH, NGAYSINH, SDT, EMAIL, DIACHI, ID_KV,ID_LOAIKH, DIEM) VALUES 
	(N'Hang Nguyen',1,'12/9/1998','2308787878', 'nguyehang@gmail.com',N'23/6 khu phố 11 Phường 10 , Quận 10', 'KV_01','KH_TH', 51)	
INSERT INTO KHACH_HANG(TEN_KH, GIOITINH, NGAYSINH, SDT, EMAIL, DIACHI, ID_KV,ID_LOAIKH, DIEM) VALUES 
	(N'Chu Ngõ Hân',0, CONVERT(date, '3/23/2000'),'0705587678', 'ngochanchu@gmail.com',N'23 Khu phố 23 phường Tân Biên, Biên Hòa Đồng Nai', 'KV_02','KH_TH', 23)
INSERT INTO KHACH_HANG(TEN_KH, GIOITINH, NGAYSINH, SDT, EMAIL, DIACHI, ID_KV,ID_LOAIKH, DIEM) VALUES 
	(N'Ngu Như Hân',0, CONVERT(date, '5/3/1997'),'0408796754', 'hangu@gmail.com',N'Thôn 14, Xã Đambri, Thành phố Bảo Lộc, Tỉnh Lâm Đồng.', 'KV_01','KH_TH', 45)
INSERT INTO KHACH_HANG(TEN_KH, GIOITINH, NGAYSINH, SDT, EMAIL, DIACHI, ID_KV,ID_LOAIKH, DIEM) VALUES 
	(N'Nguyễn Thị Lan',1, CONVERT(date, '1/7/1996'),'0705672378', 'lanthii@gmail.com',N'Số T20, Đường số 1, Khu Đô Thị Năm Sao, Xã Phước Lý, Huyện Cần Giuộc, Long An', 'KV_01','KH_TT', 300)
	SELECT * FROM KHACH_HANG;


-- INSERT TABLE CHỨC VỤ
INSERT INTO CHUC_VU VALUES('CV_LD',N'Leader')
INSERT INTO CHUC_VU VALUES('CV_NV',N'Nhân viên')


-- INSERT TABLE NHÂN VIÊN
INSERT INTO NHAN_VIEN (TEN_NV, GIOITINH, NGAYSINH, SDT, EMAIL, DIACHI, ID_CHUCVU) VALUES 
	(N'Võ Hoài Bảo',1, CONVERT(date, '11/29/1994'),'0950996583', 'baohoai@gmail.com',N' Số 2 đường Nguyễn Bỉnh Khiêm, Bến Nghé, Quận 1', 'CV_LD')
INSERT INTO NHAN_VIEN (TEN_NV, GIOITINH, NGAYSINH,SDT, EMAIL,  DIACHI, ID_CHUCVU) VALUES 
	(N'Lê Duong Bảo Lâm',1, CONVERT(date, '7/4/2000'),'0478602795', 'lduongblam@gmail.com',N' số 1 Công xã Paris, P. Bến Nghé, Q.1, TP. HCM', 'CV_NV')
INSERT INTO NHAN_VIEN (TEN_NV, GIOITINH, NGAYSINH, SDT, EMAIL, DIACHI, ID_CHUCVU) VALUES 
	(N'Võ Hoài Trâm',0, CONVERT(date, '7/27/2002'),'0569786207', 'tramvo@gmail.com',N'Số 188/1 đường Nguyễn Văn Hưởng', 'CV_NV')
INSERT INTO NHAN_VIEN (TEN_NV, GIOITINH, NGAYSINH, SDT, EMAIL, DIACHI, ID_CHUCVU) VALUES 
	(N'Lê Âu Ngân Anh',0, CONVERT(date, '3/6/1997'),'0768941076', 'nganlea@gmail.com',N'582/12 đường Huỳnh Tấn Phát', 'CV_NV')
INSERT INTO NHAN_VIEN (TEN_NV, GIOITINH, NGAYSINH, SDT, EMAIL,  DIACHI, ID_CHUCVU) VALUES 
	(N'Ưng Hoàng Phúc',1, CONVERT(date, '1/27/1998'),'054673277', 'unghoaiphuc@gmail.com',N'87/8P Xuân Thới Thượng,Ấp Xuân Thới Đông, Q.Hóc Môn', 'CV_NV')
	select * from NHAN_VIEN

-- INSERT TABLE ACCOUNT
INSERT INTO account VALUES ('nvhoaibao', '123456')
INSERT INTO account VALUES ('nvbaolam', '123456')
INSERT INTO account VALUES ('admin', '123')

-- INSERT TABLE DỊCH VỤ

SELECT * FROM DICH_VU;
INSERT INTO DICH_VU VALUES ('SP_L1', N'Lò dầu tải nhiệt', 1500000 )
INSERT INTO DICH_VU VALUES ('SP_L2', N'Lò hơi kết hợp kiểu ống nước- ống lò- ống lửa đốt than', 2020000 )
INSERT INTO DICH_VU VALUES ('SP_L3', N'Lò hơi tầng sôi', 790000)
INSERT INTO DICH_VU VALUES ('SP_TB1', N'Thiết bị trao đổi nhiệt kiểu ống có cánh',300000 )
INSERT INTO DICH_VU VALUES ('SP_TB2', N'Thiết bị trao đổi nhiệt kiểu ống vỏ', 599000 )
INSERT INTO DICH_VU VALUES ('SP_BN1', N'Bình gia nhiệt cao và hạ áp',890000 )
INSERT INTO DICH_VU VALUES ('SP_BN2', N'Bình gia nhiệt',4000000 )
INSERT INTO DICH_VU VALUES ('SP_BN3', N'Bình trao đổi nhiệt',4500000)
INSERT INTO DICH_VU VALUES ('SP_NH1', N'Nồi hơi đốt Biomass',10000000)
INSERT INTO DICH_VU VALUES ('SP_NH2', N'Nồi hơi ghi tĩnh đốt đa dạng nhiên liệu',3800000)
INSERT INTO DICH_VU VALUES ('SP_KH1', N'Dàn làm mát máy phát điện',1600000)

-- INSERT TABLE HÓA ĐƠN
INSERT INTO HOA_DON (NGAY_TAO, NGAY_HET_HAN_BH, ID_KH, ID_NV) VALUES 
	(CONVERT(date, '1/20/2022'), CONVERT(date, '7/20/2022'), 'KH00001','NV001')
INSERT INTO HOA_DON (NGAY_TAO, NGAY_HET_HAN_BH, ID_KH, ID_NV) VALUES 
	(CONVERT(date, '4/14/2022'), CONVERT(date, '10/14/2022'), 'KH00006','NV004')
INSERT INTO HOA_DON (NGAY_TAO, NGAY_HET_HAN_BH, ID_KH, ID_NV) VALUES 
	(CONVERT(date, '4/20/2022'), CONVERT(date, '10/20/2022'), 'KH00006','NV003')
INSERT INTO HOA_DON (NGAY_TAO, NGAY_HET_HAN_BH, ID_KH, ID_NV) VALUES 
	(CONVERT(date, '5/6/2022'), CONVERT(date, '7/20/2022'), 'KH00004','NV002')
INSERT INTO HOA_DON (NGAY_TAO, NGAY_HET_HAN_BH, ID_KH, ID_NV) VALUES 
	(CONVERT(date, '6/15/2022'), CONVERT(date, '12/15/2023'), 'KH00005','NV005')
INSERT INTO HOA_DON (NGAY_TAO, NGAY_HET_HAN_BH, ID_KH, ID_NV) VALUES 
	(CONVERT(date, '8/24/2022'), CONVERT(date, '2/24/2023'), 'KH00006','NV005')

-- INSERT TABLE  CHI TIẾT HÓA ĐƠN
INSERT INTO CTHD VALUES ('HDB000001','SP_BN1',2 )
INSERT INTO CTHD VALUES ('HDB000001','SP_KH1', 1)
INSERT INTO CTHD VALUES ('HDB000002','SP_L2',5)
INSERT INTO CTHD VALUES ('HDB000003','SP_NH1',2)
INSERT INTO CTHD VALUES ('HDB000003','SP_NH2', 2)
INSERT INTO CTHD VALUES ('HDB000003','SP_BN1', 3)
INSERT INTO CTHD VALUES ('HDB000004','SP_L2',5 )
INSERT INTO CTHD VALUES ('HDB000004','SP_BN3',1 )
INSERT INTO CTHD VALUES ('HDB000004','SP_L1',1 )
INSERT INTO CTHD VALUES ('HDB000005','SP_L2', 6)
INSERT INTO CTHD VALUES ('HDB000005','SP_NH2',3 )
INSERT INTO CTHD VALUES ('HDB000006','SP_NH1',7 )
INSERT INTO CTHD VALUES ('HDB000006','SP_L2', 7)
INSERT INTO CTHD VALUES ('HDB000006','SP_KH1', 7)


-- stored procedure
create procedure tao_hoadon
@ID_HOADON nchar(9)
as
Begin
select Format(SUM(ct.SO_LUONG* dv.GIA), '#,0.') 
from dbo.CTHD ct, dbo.DICH_VU dv, dbo.HOA_DON hd
where ct.ID_DV= dv.ID_DV and ct.ID_HD= hd.ID_HD and hd.ID_HD=@ID_HOADON
group by ct.ID_HD
end;

create procedure tao_hd_month_year 
@ID_HOADON nchar(9)
as
Begin
select  ct.ID_HD, hd.ID_KH, hd.ID_NV, hd.NGAY_HET_HAN_BH, hd.NGAY_TAO,
		dv.TEN_DV, dv.GIA, ct.SO_LUONG, ct.SO_LUONG * dv.GIA		
		from dbo.CTHD ct, dbo.DICH_VU dv, dbo.HOA_DON hd
									where ct.ID_DV= dv.ID_DV and ct.ID_HD= hd.ID_HD
											and hd.ID_HD=@ID_HOADON
end;

create procedure tao_khachhangall 
as
Begin
SELECT
	loai.ID_LOAIKH,
	loai.TEN_LOAIKH,
    kh.ID_KH,
	kh.TEN_KH,
	kh.GIOITINH,
	kv.TEN_KV,
	kh.DIACHI,	
	kh.EMAIL, kh.DIEM
FROM
    KHACH_HANG kh, LOAI_KHACH_HANG loai, KHU_VUC kv
WHERE
	kh.ID_LOAIKH = loai.ID_LOAIKH and kv.ID_KV = kh.ID_KV
ORDER BY
    kh.DIEM desc
end;

